{% extends "base.html" %}

{% block title %}Social Accounts - Social Media Automation V2{% endblock %}
{% block page_title %}Social Accounts{% endblock %}

{% block content %}
<!-- Header Actions -->
<div class="page-header">
    <div class="page-header-left">
        <h2>Social Media Accounts</h2>
        <p>Manage your social media accounts and credentials</p>
    </div>
    <div class="page-header-right">
        <button class="btn btn-primary" data-modal="addAccountModal">
            <i class="fas fa-plus"></i>
            Add Account
        </button>
    </div>
</div>

<!-- Stats Cards -->
<div class="stats-grid mb-4">
    <div class="stat-card">
        <div class="stat-card-header">
            <div class="stat-icon primary">
                <i class="fas fa-users"></i>
            </div>
        </div>
        <div class="stat-value" id="totalAccounts">{{ accounts|length or 0 }}</div>
        <div class="stat-label">Total Accounts</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-card-header">
            <div class="stat-icon success">
                <i class="fas fa-check-circle"></i>
            </div>
        </div>
        <div class="stat-value" id="activeAccounts">{{ active_accounts or 0 }}</div>
        <div class="stat-label">Active Accounts</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-card-header">
            <div class="stat-icon warning">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
        </div>
        <div class="stat-value" id="pendingAccounts">{{ pending_accounts or 0 }}</div>
        <div class="stat-label">Needs Attention</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-card-header">
            <div class="stat-icon info">
                <i class="fas fa-chart-line"></i>
            </div>
        </div>
        <div class="stat-value" id="successRate">{{ success_rate or 0 }}%</div>
        <div class="stat-label">Success Rate</div>
    </div>
</div>

<!-- Accounts Table -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Your Accounts</h3>
        <div class="card-actions">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" placeholder="Search accounts..." id="accountSearch">
            </div>
            <select class="form-control" id="platformFilter" style="width: auto;">
                <option value="">All Platforms</option>
                <option value="facebook">Facebook</option>
                <option value="instagram">Instagram</option>
                <option value="twitter">Twitter</option>
                <option value="linkedin">LinkedIn</option>
            </select>
        </div>
    </div>
    <div class="card-body">
        <div class="table-container">
            <table class="table" id="accountsTable">
                <thead>
                    <tr>
                        <th>Platform</th>
                        <th>Account Name</th>
                        <th>Username</th>
                        <th>Status</th>
                        <th>Last Login</th>
                        <th>Posts</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="accountsTableBody">
                    <!-- Sample data - will be populated by JavaScript -->
                    <tr>
                        <td>
                            <div class="platform-info">
                                <i class="fab fa-facebook text-primary"></i>
                                <span>Facebook</span>
                            </div>
                        </td>
                        <td>
                            <div class="account-info">
                                <strong>My Business Page</strong>
                                <small>Business Account</small>
                            </div>
                        </td>
                        <td>@mybusiness</td>
                        <td><span class="badge badge-success">Active</span></td>
                        <td>2 hours ago</td>
                        <td>
                            <span class="post-count">24</span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-primary btn-sm" data-action="test" data-id="1" data-type="account">
                                    <i class="fas fa-vial"></i>
                                </button>
                                <button class="btn btn-secondary btn-sm" data-action="edit" data-id="1">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-danger btn-sm" data-action="delete" data-id="1" data-type="account">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <div class="platform-info">
                                <i class="fab fa-instagram text-danger"></i>
                                <span>Instagram</span>
                            </div>
                        </td>
                        <td>
                            <div class="account-info">
                                <strong>Personal Account</strong>
                                <small>Personal Account</small>
                            </div>
                        </td>
                        <td>@myinstagram</td>
                        <td><span class="badge badge-warning">Needs Auth</span></td>
                        <td>1 day ago</td>
                        <td>
                            <span class="post-count">12</span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-warning btn-sm" data-action="reauth" data-id="2">
                                    <i class="fas fa-key"></i>
                                </button>
                                <button class="btn btn-secondary btn-sm" data-action="edit" data-id="2">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-danger btn-sm" data-action="delete" data-id="2" data-type="account">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block modals %}
<!-- Add Account Modal -->
<div class="modal" id="addAccountModal">
    <div class="modal-backdrop"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add Social Media Account</h3>
            <button class="modal-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="addAccountForm" data-ajax>
                <div class="form-group">
                    <label class="form-label">Platform</label>
                    <select class="form-control" name="platform" required>
                        <option value="">Select Platform</option>
                        <option value="facebook">Facebook</option>
                        <option value="instagram">Instagram</option>
                        <option value="twitter">Twitter</option>
                        <option value="linkedin">LinkedIn</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Account Name</label>
                    <input type="text" class="form-control" name="account_name" placeholder="My Business Page" required>
                    <div class="form-help">A friendly name to identify this account</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Username/Email</label>
                    <input type="text" class="form-control" name="username" placeholder="username or email" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-control" name="password" required>
                    <div class="form-help">Your password will be encrypted and stored securely</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Account Type</label>
                    <select class="form-control" name="account_type">
                        <option value="personal">Personal</option>
                        <option value="business">Business</option>
                        <option value="creator">Creator</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Proxy (Optional)</label>
                    <input type="text" class="form-control" name="proxy" placeholder="http://proxy:port">
                    <div class="form-help">Use proxy for this account (format: http://proxy:port)</div>
                </div>
                
                <div class="form-group">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" name="auto_post" id="autoPost">
                        <label class="form-check-label" for="autoPost">
                            Enable automatic posting
                        </label>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary modal-close">Cancel</button>
            <button type="submit" form="addAccountForm" class="btn btn-primary">
                <i class="fas fa-plus"></i>
                Add Account
            </button>
        </div>
    </div>
</div>

<!-- Edit Account Modal -->
<div class="modal" id="editAccountModal">
    <div class="modal-backdrop"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3>Edit Account</h3>
            <button class="modal-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="editAccountForm" data-ajax>
                <input type="hidden" name="account_id" id="editAccountId">
                
                <div class="form-group">
                    <label class="form-label">Platform</label>
                    <select class="form-control" name="platform" id="editPlatform" disabled>
                        <option value="facebook">Facebook</option>
                        <option value="instagram">Instagram</option>
                        <option value="twitter">Twitter</option>
                        <option value="linkedin">LinkedIn</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Account Name</label>
                    <input type="text" class="form-control" name="account_name" id="editAccountName" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Username/Email</label>
                    <input type="text" class="form-control" name="username" id="editUsername" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-control" name="password" id="editPassword" placeholder="Leave blank to keep current password">
                    <div class="form-help">Leave blank to keep current password</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Account Type</label>
                    <select class="form-control" name="account_type" id="editAccountType">
                        <option value="personal">Personal</option>
                        <option value="business">Business</option>
                        <option value="creator">Creator</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Proxy (Optional)</label>
                    <input type="text" class="form-control" name="proxy" id="editProxy" placeholder="http://proxy:port">
                </div>
                
                <div class="form-group">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" name="auto_post" id="editAutoPost">
                        <label class="form-check-label" for="editAutoPost">
                            Enable automatic posting
                        </label>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary modal-close">Cancel</button>
            <button type="submit" form="editAccountForm" class="btn btn-primary">
                <i class="fas fa-save"></i>
                Save Changes
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 32px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--gray-200);
}

.page-header h2 {
    font-size: 28px;
    font-weight: 700;
    margin-bottom: 8px;
    color: var(--gray-900);
}

.page-header p {
    color: var(--gray-600);
    margin: 0;
}

.card-actions {
    display: flex;
    align-items: center;
    gap: 16px;
}

.platform-info {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 500;
}

.platform-info i {
    font-size: 18px;
}

.account-info strong {
    display: block;
    font-weight: 600;
    color: var(--gray-900);
}

.account-info small {
    color: var(--gray-500);
    font-size: 12px;
}

.post-count {
    font-weight: 600;
    color: var(--primary-color);
}

.action-buttons {
    display: flex;
    gap: 8px;
}

.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: var(--transition);
}

.modal.show {
    opacity: 1;
    visibility: visible;
}

.modal-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
}

.modal-content {
    position: relative;
    background: white;
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-xl);
    width: 90%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
    transform: scale(0.9);
    transition: var(--transition);
}

.modal.show .modal-content {
    transform: scale(1);
}

.modal-header {
    padding: 24px;
    border-bottom: 1px solid var(--gray-200);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.modal-header h3 {
    font-size: 20px;
    font-weight: 600;
    margin: 0;
}

.modal-close {
    background: none;
    border: none;
    font-size: 20px;
    color: var(--gray-400);
    cursor: pointer;
    padding: 8px;
    border-radius: var(--border-radius);
    transition: var(--transition-fast);
}

.modal-close:hover {
    background: var(--gray-100);
    color: var(--gray-600);
}

.modal-body {
    padding: 24px;
}

.modal-footer {
    padding: 16px 24px;
    border-top: 1px solid var(--gray-200);
    display: flex;
    justify-content: flex-end;
    gap: 12px;
}

.form-check {
    display: flex;
    align-items: center;
    gap: 8px;
}

.form-check-input {
    width: 16px;
    height: 16px;
}

.form-check-label {
    font-size: 14px;
    color: var(--gray-700);
    cursor: pointer;
}

@media (max-width: 768px) {
    .page-header {
        flex-direction: column;
        align-items: stretch;
        gap: 20px;
    }
    
    .card-actions {
        flex-direction: column;
        align-items: stretch;
    }
    
    .action-buttons {
        justify-content: center;
    }
    
    .modal-content {
        width: 95%;
        margin: 20px;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Accounts page specific JavaScript
document.addEventListener('DOMContentLoaded', function() {
    loadAccounts();
    initAccountSearch();
    initPlatformFilter();
});

async function loadAccounts() {
    try {
        const response = await fetch('/api/accounts');
        const data = await response.json();
        
        if (data.accounts) {
            updateAccountsTable(data.accounts);
            updateAccountStats(data.stats);
        }
    } catch (error) {
        console.error('Error loading accounts:', error);
        showEmptyState();
    }
}

function updateAccountsTable(accounts) {
    const tbody = document.getElementById('accountsTableBody');
    
    if (accounts.length === 0) {
        showEmptyState();
        return;
    }
    
    tbody.innerHTML = accounts.map(account => `
        <tr data-account-id="${account.id}">
            <td>
                <div class="platform-info">
                    <i class="fab fa-${account.platform} ${getPlatformColor(account.platform)}"></i>
                    <span>${capitalizeFirst(account.platform)}</span>
                </div>
            </td>
            <td>
                <div class="account-info">
                    <strong>${account.account_name}</strong>
                    <small>${capitalizeFirst(account.account_type)} Account</small>
                </div>
            </td>
            <td>${account.username}</td>
            <td><span class="badge badge-${getStatusColor(account.status)}">${capitalizeFirst(account.status)}</span></td>
            <td>${formatTimeAgo(account.last_login)}</td>
            <td><span class="post-count">${account.post_count || 0}</span></td>
            <td>
                <div class="action-buttons">
                    ${getAccountActions(account)}
                </div>
            </td>
        </tr>
    `).join('');
}

function getAccountActions(account) {
    let actions = '';
    
    if (account.status === 'active') {
        actions += `<button class="btn btn-primary btn-sm" data-action="test" data-id="${account.id}" data-type="account" title="Test Connection">
                        <i class="fas fa-vial"></i>
                    </button>`;
    } else if (account.status === 'needs_auth') {
        actions += `<button class="btn btn-warning btn-sm" data-action="reauth" data-id="${account.id}" title="Re-authenticate">
                        <i class="fas fa-key"></i>
                    </button>`;
    }
    
    actions += `<button class="btn btn-secondary btn-sm" data-action="edit" data-id="${account.id}" title="Edit Account">
                    <i class="fas fa-edit"></i>
                </button>`;
    
    actions += `<button class="btn btn-danger btn-sm" data-action="delete" data-id="${account.id}" data-type="account" title="Delete Account">
                    <i class="fas fa-trash"></i>
                </button>`;
    
    return actions;
}

function updateAccountStats(stats) {
    if (!stats) return;
    
    document.getElementById('totalAccounts').textContent = stats.total || 0;
    document.getElementById('activeAccounts').textContent = stats.active || 0;
    document.getElementById('pendingAccounts').textContent = stats.pending || 0;
    document.getElementById('successRate').textContent = (stats.success_rate || 0) + '%';
}

function showEmptyState() {
    const tbody = document.getElementById('accountsTableBody');
    tbody.innerHTML = `
        <tr>
            <td colspan="7" class="text-center" style="padding: 60px 20px;">
                <div style="color: var(--gray-500);">
                    <i class="fas fa-users" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                    <h3>No accounts added yet</h3>
                    <p>Add your first social media account to get started</p>
                    <button class="btn btn-primary" data-modal="addAccountModal">
                        <i class="fas fa-plus"></i>
                        Add Your First Account
                    </button>
                </div>
            </td>
        </tr>
    `;
}

function initAccountSearch() {
    const searchInput = document.getElementById('accountSearch');
    searchInput.addEventListener('input', function() {
        const query = this.value.toLowerCase();
        filterAccounts(query, document.getElementById('platformFilter').value);
    });
}

function initPlatformFilter() {
    const platformFilter = document.getElementById('platformFilter');
    platformFilter.addEventListener('change', function() {
        const platform = this.value;
        filterAccounts(document.getElementById('accountSearch').value.toLowerCase(), platform);
    });
}

function filterAccounts(searchQuery, platform) {
    const rows = document.querySelectorAll('#accountsTableBody tr');
    
    rows.forEach(row => {
        const accountName = row.querySelector('.account-info strong')?.textContent.toLowerCase() || '';
        const username = row.cells[2]?.textContent.toLowerCase() || '';
        const accountPlatform = row.querySelector('.platform-info span')?.textContent.toLowerCase() || '';
        
        const matchesSearch = accountName.includes(searchQuery) || username.includes(searchQuery);
        const matchesPlatform = !platform || accountPlatform === platform.toLowerCase();
        
        row.style.display = matchesSearch && matchesPlatform ? '' : 'none';
    });
}

// Handle edit account
document.addEventListener('click', function(e) {
    if (e.target.closest('[data-action="edit"]')) {
        const accountId = e.target.closest('[data-action="edit"]').dataset.id;
        openEditModal(accountId);
    }
});

async function openEditModal(accountId) {
    try {
        const response = await fetch(`/api/accounts/${accountId}`);
        const account = await response.json();
        
        if (account) {
            // Populate edit form
            document.getElementById('editAccountId').value = account.id;
            document.getElementById('editPlatform').value = account.platform;
            document.getElementById('editAccountName').value = account.account_name;
            document.getElementById('editUsername').value = account.username;
            document.getElementById('editAccountType').value = account.account_type;
            document.getElementById('editProxy').value = account.proxy || '';
            document.getElementById('editAutoPost').checked = account.auto_post;
            
            // Open modal
            window.app.openModal('editAccountModal');
        }
    } catch (error) {
        console.error('Error loading account:', error);
        window.app.showToast('Error', 'Failed to load account details', 'error');
    }
}

// Handle re-authentication
document.addEventListener('click', function(e) {
    if (e.target.closest('[data-action="reauth"]')) {
        const accountId = e.target.closest('[data-action="reauth"]').dataset.id;
        reAuthenticateAccount(accountId);
    }
});

async function reAuthenticateAccount(accountId) {
    try {
        window.app.showLoading();
        
        const response = await fetch(`/api/accounts/${accountId}/reauth`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            window.app.showToast('Success', 'Account re-authenticated successfully', 'success');
            loadAccounts(); // Reload accounts
        } else {
            window.app.showToast('Error', result.message, 'error');
        }
    } catch (error) {
        console.error('Re-authentication error:', error);
        window.app.showToast('Error', 'Failed to re-authenticate account', 'error');
    } finally {
        window.app.hideLoading();
    }
}

// Utility functions
function getPlatformColor(platform) {
    const colors = {
        'facebook': 'text-primary',
        'instagram': 'text-danger',
        'twitter': 'text-info',
        'linkedin': 'text-primary'
    };
    return colors[platform] || 'text-muted';
}

function getStatusColor(status) {
    const colors = {
        'active': 'success',
        'inactive': 'secondary',
        'needs_auth': 'warning',
        'error': 'danger'
    };
    return colors[status] || 'secondary';
}

function capitalizeFirst(str) {
    return str.charAt(0).toUpperCase() + str.slice(1);
}

function formatTimeAgo(dateString) {
    if (!dateString) return 'Never';
    
    const date = new Date(dateString);
    const now = new Date();
    const diffInSeconds = Math.floor((now - date) / 1000);
    
    if (diffInSeconds < 60) return 'Just now';
    if (diffInSeconds < 3600) return Math.floor(diffInSeconds / 60) + ' minutes ago';
    if (diffInSeconds < 86400) return Math.floor(diffInSeconds / 3600) + ' hours ago';
    return Math.floor(diffInSeconds / 86400) + ' days ago';
}
</script>
{% endblock %}

