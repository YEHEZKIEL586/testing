{% extends "base.html" %}

{% block title %}Guest Posting - Social Media Automation V2{% endblock %}
{% block page_title %}Guest Posting{% endblock %}

{% block content %}
<!-- Header Actions -->
<div class="page-header">
    <div class="page-header-content">
        <div>
            <h1>Guest Posting Management</h1>
            <p>Manage your guest posting sites and automate content publishing</p>
        </div>
        <div class="page-actions">
            <button class="btn btn-primary" onclick="showAddSiteModal()">
                <i class="fas fa-plus"></i>
                Add Site
            </button>
            <button class="btn btn-secondary" onclick="testAllSites()">
                <i class="fas fa-check-circle"></i>
                Test All Sites
            </button>
        </div>
    </div>
</div>

<!-- Sites Overview -->
<div class="stats-grid mb-4">
    <div class="stat-card">
        <div class="stat-card-header">
            <div class="stat-icon primary">
                <i class="fas fa-globe"></i>
            </div>
        </div>
        <div class="stat-value" id="totalSites">0</div>
        <div class="stat-label">Total Sites</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-card-header">
            <div class="stat-icon success">
                <i class="fas fa-check"></i>
            </div>
        </div>
        <div class="stat-value" id="activeSites">0</div>
        <div class="stat-label">Active Sites</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-card-header">
            <div class="stat-icon warning">
                <i class="fas fa-paper-plane"></i>
            </div>
        </div>
        <div class="stat-value" id="publishedPosts">0</div>
        <div class="stat-label">Published Posts</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-card-header">
            <div class="stat-icon info">
                <i class="fas fa-percentage"></i>
            </div>
        </div>
        <div class="stat-value" id="successRate">0%</div>
        <div class="stat-label">Success Rate</div>
    </div>
</div>

<!-- Sites Management -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Guest Posting Sites</h3>
        <div class="card-actions">
            <button class="btn btn-outline btn-sm" onclick="refreshSites()">
                <i class="fas fa-refresh"></i>
                Refresh
            </button>
            <button class="btn btn-outline btn-sm" onclick="exportSites()">
                <i class="fas fa-download"></i>
                Export
            </button>
        </div>
    </div>
    
    <div class="card-body">
        <!-- Search and Filters -->
        <div class="filters-container mb-4">
            <div class="search-container">
                <input type="text" id="searchSites" class="form-control" placeholder="Search sites...">
                <i class="fas fa-search search-icon"></i>
            </div>
            
            <div class="filter-group">
                <select id="filterStatus" class="form-control">
                    <option value="">All Status</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                    <option value="error">Error</option>
                </select>
                
                <select id="filterCMS" class="form-control">
                    <option value="">All CMS</option>
                    <option value="wordpress">WordPress</option>
                    <option value="blogger">Blogger</option>
                    <option value="medium">Medium</option>
                    <option value="custom">Custom</option>
                </select>
                
                <button class="btn btn-outline" onclick="clearFilters()">
                    <i class="fas fa-times"></i>
                    Clear
                </button>
            </div>
        </div>
        
        <!-- Sites Table -->
        <div class="table-container">
            <table class="table" id="sitesTable">
                <thead>
                    <tr>
                        <th>Site Name</th>
                        <th>URL</th>
                        <th>CMS Type</th>
                        <th>Status</th>
                        <th>Last Test</th>
                        <th>Posts Published</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="sitesTableBody">
                    <!-- Sites will be loaded here -->
                </tbody>
            </table>
        </div>
        
        <!-- Loading State -->
        <div id="sitesLoading" class="loading-state" style="display: none;">
            <div class="loading-spinner"></div>
            <p>Loading sites...</p>
        </div>
        
        <!-- Empty State -->
        <div id="sitesEmpty" class="empty-state" style="display: none;">
            <i class="fas fa-globe"></i>
            <h3>No Sites Added</h3>
            <p>You haven't added any guest posting sites yet. Add your first site to get started!</p>
            <button class="btn btn-primary" onclick="showAddSiteModal()">
                <i class="fas fa-plus"></i>
                Add First Site
            </button>
        </div>
    </div>
</div>

<!-- Add Site Modal -->
<div id="addSiteModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h2>Add Guest Posting Site</h2>
            <button class="modal-close" onclick="closeAddSiteModal()">&times;</button>
        </div>
        
        <form id="addSiteForm" class="modal-body">
            <div class="form-group">
                <label for="siteName">Site Name</label>
                <input type="text" id="siteName" name="name" class="form-control" placeholder="My Blog Site" required>
            </div>
            
            <div class="form-group">
                <label for="siteUrl">Site URL</label>
                <input type="url" id="siteUrl" name="url" class="form-control" placeholder="https://example.com" required>
            </div>
            
            <div class="form-group">
                <label for="cmsType">CMS Type</label>
                <select id="cmsType" name="cms_type" class="form-control" onchange="handleCMSTypeChange()" required>
                    <option value="">Select CMS...</option>
                    <option value="wordpress">WordPress</option>
                    <option value="blogger">Blogger</option>
                    <option value="medium">Medium</option>
                    <option value="custom">Custom/Other</option>
                </select>
            </div>
            
            <!-- WordPress Specific Fields -->
            <div id="wordpressFields" class="cms-specific-fields" style="display: none;">
                <div class="form-group">
                    <label for="wpLoginUrl">WordPress Login URL</label>
                    <input type="url" id="wpLoginUrl" name="wp_login_url" class="form-control" placeholder="https://example.com/wp-admin">
                </div>
                
                <div class="form-group">
                    <label for="wpApiUrl">WordPress API URL (Optional)</label>
                    <input type="url" id="wpApiUrl" name="wp_api_url" class="form-control" placeholder="https://example.com/wp-json/wp/v2">
                </div>
            </div>
            
            <!-- Custom Fields -->
            <div id="customFields" class="cms-specific-fields" style="display: none;">
                <div class="form-group">
                    <label for="customLoginUrl">Login URL</label>
                    <input type="url" id="customLoginUrl" name="custom_login_url" class="form-control" placeholder="https://example.com/login">
                </div>
                
                <div class="form-group">
                    <label for="customPostUrl">Post Creation URL</label>
                    <input type="url" id="customPostUrl" name="custom_post_url" class="form-control" placeholder="https://example.com/create-post">
                </div>
            </div>
            
            <!-- Login Credentials -->
            <div class="form-group">
                <label for="username">Username/Email</label>
                <input type="text" id="username" name="username" class="form-control" placeholder="your-username" required>
            </div>
            
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" name="password" class="form-control" placeholder="your-password" required>
            </div>
            
            <!-- Advanced Settings -->
            <div class="form-group">
                <button type="button" class="btn btn-link" onclick="toggleAdvancedSettings()">
                    <i class="fas fa-cog"></i>
                    Advanced Settings
                </button>
            </div>
            
            <div id="advancedSettings" style="display: none;">
                <div class="form-group">
                    <label for="defaultCategory">Default Category</label>
                    <input type="text" id="defaultCategory" name="default_category" class="form-control" placeholder="General">
                </div>
                
                <div class="form-group">
                    <label for="defaultTags">Default Tags</label>
                    <input type="text" id="defaultTags" name="default_tags" class="form-control" placeholder="tag1, tag2, tag3">
                </div>
                
                <div class="form-group">
                    <label for="postStatus">Default Post Status</label>
                    <select id="postStatus" name="post_status" class="form-control">
                        <option value="draft">Draft</option>
                        <option value="publish">Publish</option>
                        <option value="pending">Pending Review</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="enableScheduling" name="enable_scheduling">
                        <label for="enableScheduling">Enable Scheduling</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="enableSEO" name="enable_seo" checked>
                        <label for="enableSEO">Enable SEO Optimization</label>
                    </div>
                </div>
            </div>
        </form>
        
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeAddSiteModal()">Cancel</button>
            <button type="button" class="btn btn-info" onclick="testSiteConnection()">Test Connection</button>
            <button type="button" class="btn btn-primary" onclick="addSite()">Add Site</button>
        </div>
    </div>
</div>

<!-- Edit Site Modal -->
<div id="editSiteModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h2>Edit Site</h2>
            <button class="modal-close" onclick="closeEditSiteModal()">&times;</button>
        </div>
        
        <form id="editSiteForm" class="modal-body">
            <input type="hidden" id="editSiteId" name="site_id">
            <!-- Same fields as add site form -->
            <div class="form-group">
                <label for="editSiteName">Site Name</label>
                <input type="text" id="editSiteName" name="name" class="form-control" required>
            </div>
            
            <div class="form-group">
                <label for="editSiteUrl">Site URL</label>
                <input type="url" id="editSiteUrl" name="url" class="form-control" required>
            </div>
            
            <div class="form-group">
                <label for="editCmsType">CMS Type</label>
                <select id="editCmsType" name="cms_type" class="form-control" required>
                    <option value="wordpress">WordPress</option>
                    <option value="blogger">Blogger</option>
                    <option value="medium">Medium</option>
                    <option value="custom">Custom/Other</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="editUsername">Username/Email</label>
                <input type="text" id="editUsername" name="username" class="form-control" required>
            </div>
            
            <div class="form-group">
                <label for="editPassword">Password</label>
                <input type="password" id="editPassword" name="password" class="form-control" placeholder="Leave blank to keep current password">
            </div>
        </form>
        
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeEditSiteModal()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="updateSite()">Update Site</button>
        </div>
    </div>
</div>

<!-- Site Details Modal -->
<div id="siteDetailsModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h2 id="siteDetailsTitle">Site Details</h2>
            <button class="modal-close" onclick="closeSiteDetailsModal()">&times;</button>
        </div>
        
        <div class="modal-body">
            <div id="siteDetailsContent">
                <!-- Site details will be loaded here -->
            </div>
        </div>
        
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeSiteDetailsModal()">Close</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.page-header {
    margin-bottom: 32px;
}

.page-header-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 20px;
}

.page-header h1 {
    margin: 0 0 8px 0;
    font-size: 32px;
    font-weight: 700;
    color: var(--gray-900);
}

.page-header p {
    margin: 0;
    color: var(--gray-600);
    font-size: 16px;
}

.page-actions {
    display: flex;
    gap: 12px;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 24px;
    margin-bottom: 32px;
}

.stat-card {
    background: white;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    border: 1px solid var(--gray-200);
}

.stat-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
}

.stat-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    color: white;
}

.stat-icon.primary {
    background: var(--primary-color);
}

.stat-icon.success {
    background: var(--success-color);
}

.stat-icon.warning {
    background: var(--warning-color);
}

.stat-icon.info {
    background: var(--info-color);
}

.stat-value {
    font-size: 32px;
    font-weight: 700;
    color: var(--gray-900);
    margin-bottom: 8px;
}

.stat-label {
    font-size: 14px;
    color: var(--gray-600);
    font-weight: 500;
}

.filters-container {
    display: flex;
    align-items: center;
    gap: 16px;
    flex-wrap: wrap;
}

.search-container {
    position: relative;
    flex: 1;
    min-width: 250px;
}

.search-container .search-icon {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--gray-400);
}

.search-container input {
    padding-left: 40px;
}

.filter-group {
    display: flex;
    gap: 12px;
    align-items: center;
}

.filter-group select {
    min-width: 150px;
}

.table-container {
    overflow-x: auto;
}

.table {
    width: 100%;
    border-collapse: collapse;
}

.table th,
.table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid var(--gray-200);
}

.table th {
    background: var(--gray-50);
    font-weight: 600;
    color: var(--gray-700);
}

.table tbody tr:hover {
    background: var(--gray-50);
}

.site-name {
    font-weight: 600;
    color: var(--gray-900);
}

.site-url {
    color: var(--primary-color);
    text-decoration: none;
    font-size: 14px;
}

.site-url:hover {
    text-decoration: underline;
}

.cms-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
    background: var(--gray-100);
    color: var(--gray-700);
}

.cms-badge.wordpress {
    background: #21759b;
    color: white;
}

.cms-badge.blogger {
    background: #ff5722;
    color: white;
}

.cms-badge.medium {
    background: #00ab6c;
    color: white;
}

.cms-badge.custom {
    background: var(--gray-600);
    color: white;
}

.status-badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
}

.status-badge.active {
    background: var(--success-color);
    color: white;
}

.status-badge.inactive {
    background: var(--gray-400);
    color: white;
}

.status-badge.error {
    background: var(--danger-color);
    color: white;
}

.site-actions {
    display: flex;
    gap: 4px;
}

.site-actions .btn {
    padding: 4px 8px;
    font-size: 12px;
}

.cms-specific-fields {
    border: 1px solid var(--gray-200);
    border-radius: 8px;
    padding: 16px;
    margin: 16px 0;
    background: var(--gray-50);
}

.checkbox-group {
    display: flex;
    align-items: center;
    gap: 8px;
}

.checkbox-group input[type="checkbox"] {
    margin: 0;
}

.checkbox-group label {
    margin: 0;
    cursor: pointer;
}

.loading-state {
    text-align: center;
    padding: 60px 20px;
}

.loading-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid var(--gray-200);
    border-top: 4px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 16px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--gray-500);
}

.empty-state i {
    font-size: 64px;
    margin-bottom: 16px;
    opacity: 0.5;
}

.empty-state h3 {
    margin: 0 0 8px 0;
    font-size: 24px;
    color: var(--gray-700);
}

.empty-state p {
    margin: 0 0 20px 0;
    font-size: 16px;
}

@media (max-width: 768px) {
    .page-header-content {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .page-actions {
        width: 100%;
        justify-content: stretch;
    }
    
    .page-actions .btn {
        flex: 1;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .filters-container {
        flex-direction: column;
        align-items: stretch;
    }
    
    .filter-group {
        flex-wrap: wrap;
    }
    
    .filter-group select {
        min-width: auto;
        flex: 1;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Guest posting variables
let allSites = [];
let filteredSites = [];

// Initialize guest posting page
document.addEventListener('DOMContentLoaded', function() {
    loadSites();
    loadStats();
    setupEventListeners();
});

function setupEventListeners() {
    // Search functionality
    document.getElementById('searchSites').addEventListener('input', debounce(filterSites, 300));
    
    // Filter functionality
    document.getElementById('filterStatus').addEventListener('change', filterSites);
    document.getElementById('filterCMS').addEventListener('change', filterSites);
}

async function loadSites() {
    showLoading();
    
    try {
        const response = await fetch('/api/guest-posting/sites');
        const data = await response.json();
        
        if (data.success) {
            allSites = data.sites || [];
            filteredSites = [...allSites];
            
            renderSites();
            
            if (allSites.length === 0) {
                showEmptyState();
            } else {
                hideEmptyState();
            }
        } else {
            showNotification(data.message || 'Error loading sites', 'error');
            showEmptyState();
        }
    } catch (error) {
        console.error('Error loading sites:', error);
        showNotification('Error loading sites', 'error');
        showEmptyState();
    } finally {
        hideLoading();
    }
}

async function loadStats() {
    try {
        const response = await fetch('/api/guest-posting/stats');
        const data = await response.json();
        
        if (data.success) {
            const stats = data.stats;
            document.getElementById('totalSites').textContent = stats.total_sites || 0;
            document.getElementById('activeSites').textContent = stats.active_sites || 0;
            document.getElementById('publishedPosts').textContent = stats.published_posts || 0;
            document.getElementById('successRate').textContent = (stats.success_rate || 0) + '%';
        }
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

function renderSites() {
    const tbody = document.getElementById('sitesTableBody');
    tbody.innerHTML = '';
    
    filteredSites.forEach(site => {
        const row = createSiteRow(site);
        tbody.appendChild(row);
    });
}

function createSiteRow(site) {
    const row = document.createElement('tr');
    
    // Format last test date
    const lastTest = site.last_test ? new Date(site.last_test).toLocaleDateString() : 'Never';
    
    row.innerHTML = `
        <td>
            <div class="site-name">${site.name}</div>
        </td>
        <td>
            <a href="${site.url}" target="_blank" class="site-url">${site.url}</a>
        </td>
        <td>
            <span class="cms-badge ${site.cms_type}">
                ${site.cms_type.charAt(0).toUpperCase() + site.cms_type.slice(1)}
            </span>
        </td>
        <td>
            <span class="status-badge ${site.status}">${site.status}</span>
        </td>
        <td>${lastTest}</td>
        <td>${site.posts_published || 0}</td>
        <td>
            <div class="site-actions">
                <button class="btn btn-info btn-sm" onclick="testSite(${site.id})" title="Test Connection">
                    <i class="fas fa-check"></i>
                </button>
                <button class="btn btn-primary btn-sm" onclick="editSite(${site.id})" title="Edit">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-secondary btn-sm" onclick="viewSiteDetails(${site.id})" title="View Details">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-danger btn-sm" onclick="deleteSite(${site.id})" title="Delete">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </td>
    `;
    
    return row;
}

function filterSites() {
    const searchTerm = document.getElementById('searchSites').value.toLowerCase();
    const statusFilter = document.getElementById('filterStatus').value;
    const cmsFilter = document.getElementById('filterCMS').value;
    
    filteredSites = allSites.filter(site => {
        const matchesSearch = !searchTerm || 
            site.name.toLowerCase().includes(searchTerm) ||
            site.url.toLowerCase().includes(searchTerm);
        
        const matchesStatus = !statusFilter || site.status === statusFilter;
        const matchesCMS = !cmsFilter || site.cms_type === cmsFilter;
        
        return matchesSearch && matchesStatus && matchesCMS;
    });
    
    renderSites();
    
    if (filteredSites.length === 0) {
        showEmptyState();
    } else {
        hideEmptyState();
    }
}

function clearFilters() {
    document.getElementById('searchSites').value = '';
    document.getElementById('filterStatus').value = '';
    document.getElementById('filterCMS').value = '';
    
    filteredSites = [...allSites];
    renderSites();
    hideEmptyState();
}

function showAddSiteModal() {
    document.getElementById('addSiteModal').style.display = 'flex';
}

function closeAddSiteModal() {
    document.getElementById('addSiteModal').style.display = 'none';
    document.getElementById('addSiteForm').reset();
    document.querySelectorAll('.cms-specific-fields').forEach(el => el.style.display = 'none');
    document.getElementById('advancedSettings').style.display = 'none';
}

function handleCMSTypeChange() {
    const cmsType = document.getElementById('cmsType').value;
    
    // Hide all CMS specific fields
    document.querySelectorAll('.cms-specific-fields').forEach(el => el.style.display = 'none');
    
    // Show relevant fields
    if (cmsType === 'wordpress') {
        document.getElementById('wordpressFields').style.display = 'block';
    } else if (cmsType === 'custom') {
        document.getElementById('customFields').style.display = 'block';
    }
}

function toggleAdvancedSettings() {
    const section = document.getElementById('advancedSettings');
    const isVisible = section.style.display !== 'none';
    section.style.display = isVisible ? 'none' : 'block';
}

async function testSiteConnection() {
    const formData = new FormData(document.getElementById('addSiteForm'));
    
    try {
        showNotification('Testing site connection...', 'info');
        
        const response = await fetch('/api/guest-posting/test-connection', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('Connection test successful!', 'success');
        } else {
            showNotification(data.message || 'Connection test failed', 'error');
        }
    } catch (error) {
        console.error('Error testing connection:', error);
        showNotification('Error testing connection', 'error');
    }
}

async function addSite() {
    const formData = new FormData(document.getElementById('addSiteForm'));
    
    try {
        const response = await fetch('/api/guest-posting/sites', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('Site added successfully!', 'success');
            closeAddSiteModal();
            loadSites();
            loadStats();
        } else {
            showNotification(data.message || 'Error adding site', 'error');
        }
    } catch (error) {
        console.error('Error adding site:', error);
        showNotification('Error adding site', 'error');
    }
}

async function editSite(siteId) {
    try {
        const response = await fetch(`/api/guest-posting/sites/${siteId}`);
        const data = await response.json();
        
        if (data.success) {
            const site = data.site;
            
            // Populate edit form
            document.getElementById('editSiteId').value = site.id;
            document.getElementById('editSiteName').value = site.name;
            document.getElementById('editSiteUrl').value = site.url;
            document.getElementById('editCmsType').value = site.cms_type;
            document.getElementById('editUsername').value = site.username;
            
            // Show modal
            document.getElementById('editSiteModal').style.display = 'flex';
        } else {
            showNotification(data.message || 'Error loading site', 'error');
        }
    } catch (error) {
        console.error('Error loading site:', error);
        showNotification('Error loading site', 'error');
    }
}

function closeEditSiteModal() {
    document.getElementById('editSiteModal').style.display = 'none';
}

async function updateSite() {
    const formData = new FormData(document.getElementById('editSiteForm'));
    const siteId = formData.get('site_id');
    
    try {
        const response = await fetch(`/api/guest-posting/sites/${siteId}`, {
            method: 'PUT',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('Site updated successfully!', 'success');
            closeEditSiteModal();
            loadSites();
        } else {
            showNotification(data.message || 'Error updating site', 'error');
        }
    } catch (error) {
        console.error('Error updating site:', error);
        showNotification('Error updating site', 'error');
    }
}

async function testSite(siteId) {
    try {
        showNotification('Testing site connection...', 'info');
        
        const response = await fetch(`/api/guest-posting/sites/${siteId}/test`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('Site test successful!', 'success');
            loadSites();
        } else {
            showNotification(data.message || 'Site test failed', 'error');
        }
    } catch (error) {
        console.error('Error testing site:', error);
        showNotification('Error testing site', 'error');
    }
}

async function testAllSites() {
    if (allSites.length === 0) {
        showNotification('No sites to test', 'warning');
        return;
    }
    
    try {
        showNotification('Testing all sites...', 'info');
        
        const response = await fetch('/api/guest-posting/test-all', {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification(`Tested ${data.tested} sites. ${data.successful} successful, ${data.failed} failed.`, 'success');
            loadSites();
            loadStats();
        } else {
            showNotification(data.message || 'Error testing sites', 'error');
        }
    } catch (error) {
        console.error('Error testing sites:', error);
        showNotification('Error testing sites', 'error');
    }
}

async function viewSiteDetails(siteId) {
    try {
        const response = await fetch(`/api/guest-posting/sites/${siteId}/details`);
        const data = await response.json();
        
        if (data.success) {
            const site = data.site;
            
            document.getElementById('siteDetailsTitle').textContent = site.name;
            document.getElementById('siteDetailsContent').innerHTML = `
                <div class="site-details">
                    <div class="detail-section">
                        <h4>Basic Information</h4>
                        <p><strong>Name:</strong> ${site.name}</p>
                        <p><strong>URL:</strong> <a href="${site.url}" target="_blank">${site.url}</a></p>
                        <p><strong>CMS Type:</strong> ${site.cms_type}</p>
                        <p><strong>Status:</strong> <span class="status-badge ${site.status}">${site.status}</span></p>
                    </div>
                    
                    <div class="detail-section">
                        <h4>Statistics</h4>
                        <p><strong>Posts Published:</strong> ${site.posts_published || 0}</p>
                        <p><strong>Last Test:</strong> ${site.last_test ? new Date(site.last_test).toLocaleString() : 'Never'}</p>
                        <p><strong>Success Rate:</strong> ${site.success_rate || 0}%</p>
                    </div>
                    
                    <div class="detail-section">
                        <h4>Recent Activity</h4>
                        <div id="recentActivity">Loading...</div>
                    </div>
                </div>
            `;
            
            // Load recent activity
            loadSiteActivity(siteId);
            
            document.getElementById('siteDetailsModal').style.display = 'flex';
        } else {
            showNotification(data.message || 'Error loading site details', 'error');
        }
    } catch (error) {
        console.error('Error loading site details:', error);
        showNotification('Error loading site details', 'error');
    }
}

async function loadSiteActivity(siteId) {
    try {
        const response = await fetch(`/api/guest-posting/sites/${siteId}/activity`);
        const data = await response.json();
        
        if (data.success) {
            const activities = data.activities || [];
            const activityHtml = activities.length > 0 
                ? activities.map(activity => `
                    <div class="activity-item">
                        <span class="activity-date">${new Date(activity.created_at).toLocaleString()}</span>
                        <span class="activity-description">${activity.description}</span>
                    </div>
                `).join('')
                : '<p>No recent activity</p>';
            
            document.getElementById('recentActivity').innerHTML = activityHtml;
        } else {
            document.getElementById('recentActivity').innerHTML = '<p>Error loading activity</p>';
        }
    } catch (error) {
        console.error('Error loading site activity:', error);
        document.getElementById('recentActivity').innerHTML = '<p>Error loading activity</p>';
    }
}

function closeSiteDetailsModal() {
    document.getElementById('siteDetailsModal').style.display = 'none';
}

async function deleteSite(siteId) {
    if (!confirm('Are you sure you want to delete this site? This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/guest-posting/sites/${siteId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('Site deleted successfully!', 'success');
            loadSites();
            loadStats();
        } else {
            showNotification(data.message || 'Error deleting site', 'error');
        }
    } catch (error) {
        console.error('Error deleting site:', error);
        showNotification('Error deleting site', 'error');
    }
}

function refreshSites() {
    showNotification('Refreshing sites...', 'info');
    loadSites();
    loadStats();
}

async function exportSites() {
    try {
        const response = await fetch('/api/guest-posting/sites/export');
        const blob = await response.blob();
        
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `guest_posting_sites_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        showNotification('Sites exported successfully!', 'success');
    } catch (error) {
        console.error('Error exporting sites:', error);
        showNotification('Error exporting sites', 'error');
    }
}

function showLoading() {
    document.getElementById('sitesLoading').style.display = 'block';
    document.getElementById('sitesTable').style.display = 'none';
    document.getElementById('sitesEmpty').style.display = 'none';
}

function hideLoading() {
    document.getElementById('sitesLoading').style.display = 'none';
    document.getElementById('sitesTable').style.display = 'table';
}

function showEmptyState() {
    document.getElementById('sitesEmpty').style.display = 'block';
    document.getElementById('sitesTable').style.display = 'none';
}

function hideEmptyState() {
    document.getElementById('sitesEmpty').style.display = 'none';
    document.getElementById('sitesTable').style.display = 'table';
}

// Utility function for debouncing
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Close modals when clicking outside
document.getElementById('addSiteModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeAddSiteModal();
    }
});

document.getElementById('editSiteModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeEditSiteModal();
    }
});

document.getElementById('siteDetailsModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeSiteDetailsModal();
    }
});

// Close modals with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        if (document.getElementById('addSiteModal').style.display === 'flex') {
            closeAddSiteModal();
        }
        if (document.getElementById('editSiteModal').style.display === 'flex') {
            closeEditSiteModal();
        }
        if (document.getElementById('siteDetailsModal').style.display === 'flex') {
            closeSiteDetailsModal();
        }
    }
});
</script>
{% endblock %}

