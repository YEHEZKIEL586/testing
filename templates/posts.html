{% extends "base.html" %}

{% block title %}Posts - Social Media Automation V2{% endblock %}
{% block page_title %}Posts Management{% endblock %}

{% block content %}
<!-- Header Actions -->
<div class="page-header">
    <div class="page-header-content">
        <div>
            <h1>Posts Management</h1>
            <p>Create, schedule, and manage your social media posts</p>
        </div>
        <div class="page-actions">
            <button class="btn btn-primary" onclick="showCreatePostModal()">
                <i class="fas fa-plus"></i>
                Create New Post
            </button>
            <button class="btn btn-secondary" onclick="showBulkActionsModal()">
                <i class="fas fa-tasks"></i>
                Bulk Actions
            </button>
        </div>
    </div>
</div>

<!-- Filters and Search -->
<div class="card mb-4">
    <div class="card-body">
        <div class="filters-container">
            <div class="search-container">
                <input type="text" id="searchPosts" class="form-control" placeholder="Search posts...">
                <i class="fas fa-search search-icon"></i>
            </div>
            
            <div class="filter-group">
                <select id="filterStatus" class="form-control">
                    <option value="">All Status</option>
                    <option value="draft">Draft</option>
                    <option value="scheduled">Scheduled</option>
                    <option value="published">Published</option>
                    <option value="failed">Failed</option>
                </select>
                
                <select id="filterPlatform" class="form-control">
                    <option value="">All Platforms</option>
                    <option value="facebook">Facebook</option>
                    <option value="instagram">Instagram</option>
                    <option value="twitter">Twitter</option>
                    <option value="linkedin">LinkedIn</option>
                </select>
                
                <select id="filterAccount" class="form-control">
                    <option value="">All Accounts</option>
                </select>
                
                <button class="btn btn-outline" onclick="clearFilters()">
                    <i class="fas fa-times"></i>
                    Clear
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Posts Table -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">All Posts</h3>
        <div class="card-actions">
            <button class="btn btn-outline btn-sm" onclick="refreshPosts()">
                <i class="fas fa-refresh"></i>
                Refresh
            </button>
            <button class="btn btn-outline btn-sm" onclick="exportPosts()">
                <i class="fas fa-download"></i>
                Export
            </button>
        </div>
    </div>
    
    <div class="card-body">
        <div class="table-container">
            <table class="table" id="postsTable">
                <thead>
                    <tr>
                        <th>
                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                        </th>
                        <th>Content</th>
                        <th>Platform</th>
                        <th>Account</th>
                        <th>Status</th>
                        <th>Scheduled</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="postsTableBody">
                    <!-- Posts will be loaded here -->
                </tbody>
            </table>
        </div>
        
        <!-- Loading State -->
        <div id="postsLoading" class="loading-state" style="display: none;">
            <div class="loading-spinner"></div>
            <p>Loading posts...</p>
        </div>
        
        <!-- Empty State -->
        <div id="postsEmpty" class="empty-state" style="display: none;">
            <i class="fas fa-paper-plane"></i>
            <h3>No Posts Found</h3>
            <p>You haven't created any posts yet. Create your first post to get started!</p>
            <button class="btn btn-primary" onclick="showCreatePostModal()">
                <i class="fas fa-plus"></i>
                Create First Post
            </button>
        </div>
    </div>
    
    <!-- Pagination -->
    <div class="card-footer">
        <div class="pagination-container">
            <div class="pagination-info">
                Showing <span id="paginationStart">0</span> to <span id="paginationEnd">0</span> of <span id="paginationTotal">0</span> posts
            </div>
            <div class="pagination-controls">
                <button class="btn btn-outline btn-sm" id="prevPage" onclick="previousPage()" disabled>
                    <i class="fas fa-chevron-left"></i>
                    Previous
                </button>
                <span id="pageNumbers"></span>
                <button class="btn btn-outline btn-sm" id="nextPage" onclick="nextPage()" disabled>
                    Next
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Include Create Post Modal -->
{% include 'create_post_modal.html' %}

<!-- Edit Post Modal -->
<div id="editPostModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h2>Edit Post</h2>
            <button class="modal-close" onclick="closeEditPostModal()">&times;</button>
        </div>
        
        <form id="editPostForm" class="modal-body">
            <input type="hidden" id="editPostId" name="post_id">
            
            <div class="form-group">
                <label for="editPostTitle">Title</label>
                <input type="text" id="editPostTitle" name="title" class="form-control">
            </div>
            
            <div class="form-group">
                <label for="editPostContent">Content</label>
                <textarea id="editPostContent" name="content" class="form-control" rows="6"></textarea>
            </div>
            
            <div class="form-group">
                <label for="editPostPlatform">Platform</label>
                <select id="editPostPlatform" name="platform" class="form-control">
                    <option value="facebook">Facebook</option>
                    <option value="instagram">Instagram</option>
                    <option value="twitter">Twitter</option>
                    <option value="linkedin">LinkedIn</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="editPostAccount">Account</label>
                <select id="editPostAccount" name="account_id" class="form-control">
                    <!-- Accounts will be loaded here -->
                </select>
            </div>
            
            <div class="form-group">
                <label for="editPostStatus">Status</label>
                <select id="editPostStatus" name="status" class="form-control">
                    <option value="draft">Draft</option>
                    <option value="scheduled">Scheduled</option>
                    <option value="published">Published</option>
                </select>
            </div>
        </form>
        
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeEditPostModal()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="updatePost()">Update Post</button>
        </div>
    </div>
</div>

<!-- Bulk Actions Modal -->
<div id="bulkActionsModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h2>Bulk Actions</h2>
            <button class="modal-close" onclick="closeBulkActionsModal()">&times;</button>
        </div>
        
        <div class="modal-body">
            <div class="form-group">
                <label>Select Action</label>
                <select id="bulkAction" class="form-control">
                    <option value="">Choose action...</option>
                    <option value="publish">Publish Selected</option>
                    <option value="schedule">Schedule Selected</option>
                    <option value="delete">Delete Selected</option>
                    <option value="duplicate">Duplicate Selected</option>
                </select>
            </div>
            
            <div id="bulkScheduleSection" class="form-group" style="display: none;">
                <label for="bulkScheduleDate">Schedule Date & Time</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <input type="date" id="bulkScheduleDate" class="form-control">
                    <input type="time" id="bulkScheduleTime" class="form-control">
                </div>
            </div>
            
            <div class="selected-posts-info">
                <p><span id="selectedPostsCount">0</span> posts selected</p>
            </div>
        </div>
        
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeBulkActionsModal()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="executeBulkAction()">Execute Action</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.page-header {
    margin-bottom: 32px;
}

.page-header-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 20px;
}

.page-header h1 {
    margin: 0 0 8px 0;
    font-size: 32px;
    font-weight: 700;
    color: var(--gray-900);
}

.page-header p {
    margin: 0;
    color: var(--gray-600);
    font-size: 16px;
}

.page-actions {
    display: flex;
    gap: 12px;
}

.filters-container {
    display: flex;
    align-items: center;
    gap: 16px;
    flex-wrap: wrap;
}

.search-container {
    position: relative;
    flex: 1;
    min-width: 250px;
}

.search-container .search-icon {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--gray-400);
}

.search-container input {
    padding-left: 40px;
}

.filter-group {
    display: flex;
    gap: 12px;
    align-items: center;
}

.filter-group select {
    min-width: 150px;
}

.table-container {
    overflow-x: auto;
}

.table {
    width: 100%;
    border-collapse: collapse;
}

.table th,
.table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid var(--gray-200);
}

.table th {
    background: var(--gray-50);
    font-weight: 600;
    color: var(--gray-700);
}

.table tbody tr:hover {
    background: var(--gray-50);
}

.post-content-preview {
    max-width: 300px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.post-content-preview h4 {
    margin: 0 0 4px 0;
    font-size: 14px;
    font-weight: 600;
    color: var(--gray-900);
}

.post-content-preview p {
    margin: 0;
    font-size: 13px;
    color: var(--gray-600);
}

.platform-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
}

.platform-badge.facebook {
    background: #1877f2;
    color: white;
}

.platform-badge.instagram {
    background: #e4405f;
    color: white;
}

.platform-badge.twitter {
    background: #1da1f2;
    color: white;
}

.platform-badge.linkedin {
    background: #0077b5;
    color: white;
}

.status-badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
}

.status-badge.draft {
    background: var(--gray-200);
    color: var(--gray-700);
}

.status-badge.scheduled {
    background: var(--warning-color);
    color: white;
}

.status-badge.published {
    background: var(--success-color);
    color: white;
}

.status-badge.failed {
    background: var(--danger-color);
    color: white;
}

.post-actions {
    display: flex;
    gap: 4px;
}

.post-actions .btn {
    padding: 4px 8px;
    font-size: 12px;
}

.pagination-container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 0;
}

.pagination-info {
    font-size: 14px;
    color: var(--gray-600);
}

.pagination-controls {
    display: flex;
    align-items: center;
    gap: 8px;
}

.page-number {
    padding: 6px 12px;
    border: 1px solid var(--gray-300);
    background: white;
    color: var(--gray-700);
    text-decoration: none;
    border-radius: 4px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.page-number:hover {
    background: var(--gray-50);
    border-color: var(--gray-400);
}

.page-number.active {
    background: var(--primary-color);
    border-color: var(--primary-color);
    color: white;
}

.loading-state {
    text-align: center;
    padding: 60px 20px;
}

.loading-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid var(--gray-200);
    border-top: 4px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 16px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--gray-500);
}

.empty-state i {
    font-size: 64px;
    margin-bottom: 16px;
    opacity: 0.5;
}

.empty-state h3 {
    margin: 0 0 8px 0;
    font-size: 24px;
    color: var(--gray-700);
}

.empty-state p {
    margin: 0 0 20px 0;
    font-size: 16px;
}

.selected-posts-info {
    background: var(--gray-50);
    padding: 12px;
    border-radius: 6px;
    margin-top: 16px;
}

.selected-posts-info p {
    margin: 0;
    font-size: 14px;
    color: var(--gray-600);
}

@media (max-width: 768px) {
    .page-header-content {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .page-actions {
        width: 100%;
        justify-content: stretch;
    }
    
    .page-actions .btn {
        flex: 1;
    }
    
    .filters-container {
        flex-direction: column;
        align-items: stretch;
    }
    
    .filter-group {
        flex-wrap: wrap;
    }
    
    .filter-group select {
        min-width: auto;
        flex: 1;
    }
    
    .pagination-container {
        flex-direction: column;
        gap: 16px;
    }
    
    .pagination-controls {
        flex-wrap: wrap;
        justify-content: center;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Posts management variables
let currentPage = 1;
let postsPerPage = 10;
let totalPosts = 0;
let allPosts = [];
let filteredPosts = [];
let selectedPosts = [];

// Initialize posts page
document.addEventListener('DOMContentLoaded', function() {
    loadPosts();
    loadAccountsForFilter();
    setupEventListeners();
});

function setupEventListeners() {
    // Search functionality
    document.getElementById('searchPosts').addEventListener('input', debounce(filterPosts, 300));
    
    // Filter functionality
    document.getElementById('filterStatus').addEventListener('change', filterPosts);
    document.getElementById('filterPlatform').addEventListener('change', filterPosts);
    document.getElementById('filterAccount').addEventListener('change', filterPosts);
    
    // Bulk action change
    document.getElementById('bulkAction').addEventListener('change', function() {
        const action = this.value;
        const scheduleSection = document.getElementById('bulkScheduleSection');
        scheduleSection.style.display = action === 'schedule' ? 'block' : 'none';
    });
}

async function loadPosts() {
    showLoading();
    
    try {
        const response = await fetch('/api/posts');
        const data = await response.json();
        
        if (data.success) {
            allPosts = data.posts || [];
            filteredPosts = [...allPosts];
            totalPosts = allPosts.length;
            
            renderPosts();
            updatePagination();
            
            if (allPosts.length === 0) {
                showEmptyState();
            } else {
                hideEmptyState();
            }
        } else {
            showNotification(data.message || 'Error loading posts', 'error');
            showEmptyState();
        }
    } catch (error) {
        console.error('Error loading posts:', error);
        showNotification('Error loading posts', 'error');
        showEmptyState();
    } finally {
        hideLoading();
    }
}

async function loadAccountsForFilter() {
    try {
        const response = await fetch('/api/accounts');
        const data = await response.json();
        
        if (data.success && data.accounts) {
            const select = document.getElementById('filterAccount');
            select.innerHTML = '<option value="">All Accounts</option>';
            
            data.accounts.forEach(account => {
                const option = document.createElement('option');
                option.value = account.id;
                option.textContent = `${account.platform} - ${account.account_name}`;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error loading accounts:', error);
    }
}

function renderPosts() {
    const tbody = document.getElementById('postsTableBody');
    const startIndex = (currentPage - 1) * postsPerPage;
    const endIndex = startIndex + postsPerPage;
    const postsToShow = filteredPosts.slice(startIndex, endIndex);
    
    tbody.innerHTML = '';
    
    postsToShow.forEach(post => {
        const row = createPostRow(post);
        tbody.appendChild(row);
    });
}

function createPostRow(post) {
    const row = document.createElement('tr');
    
    // Format dates
    const createdDate = new Date(post.created_at).toLocaleDateString();
    const scheduledDate = post.scheduled_at ? new Date(post.scheduled_at).toLocaleString() : '-';
    
    row.innerHTML = `
        <td>
            <input type="checkbox" class="post-checkbox" value="${post.id}" onchange="updateSelectedPosts()">
        </td>
        <td>
            <div class="post-content-preview">
                <h4>${post.title || 'Untitled'}</h4>
                <p>${post.content ? post.content.substring(0, 100) + '...' : 'No content'}</p>
            </div>
        </td>
        <td>
            <span class="platform-badge ${post.platform}">
                <i class="fab fa-${post.platform}"></i>
                ${post.platform.charAt(0).toUpperCase() + post.platform.slice(1)}
            </span>
        </td>
        <td>${post.account_name || 'No account'}</td>
        <td>
            <span class="status-badge ${post.status}">${post.status}</span>
        </td>
        <td>${scheduledDate}</td>
        <td>${createdDate}</td>
        <td>
            <div class="post-actions">
                <button class="btn btn-primary btn-sm" onclick="editPost(${post.id})" title="Edit">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-success btn-sm" onclick="duplicatePost(${post.id})" title="Duplicate">
                    <i class="fas fa-copy"></i>
                </button>
                ${post.status === 'failed' ? `
                    <button class="btn btn-warning btn-sm" onclick="retryPost(${post.id})" title="Retry">
                        <i class="fas fa-redo"></i>
                    </button>
                ` : ''}
                ${post.status === 'draft' || post.status === 'scheduled' ? `
                    <button class="btn btn-info btn-sm" onclick="publishPost(${post.id})" title="Publish">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                ` : ''}
                <button class="btn btn-danger btn-sm" onclick="deletePost(${post.id})" title="Delete">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </td>
    `;
    
    return row;
}

function filterPosts() {
    const searchTerm = document.getElementById('searchPosts').value.toLowerCase();
    const statusFilter = document.getElementById('filterStatus').value;
    const platformFilter = document.getElementById('filterPlatform').value;
    const accountFilter = document.getElementById('filterAccount').value;
    
    filteredPosts = allPosts.filter(post => {
        const matchesSearch = !searchTerm || 
            (post.title && post.title.toLowerCase().includes(searchTerm)) ||
            (post.content && post.content.toLowerCase().includes(searchTerm));
        
        const matchesStatus = !statusFilter || post.status === statusFilter;
        const matchesPlatform = !platformFilter || post.platform === platformFilter;
        const matchesAccount = !accountFilter || post.account_id == accountFilter;
        
        return matchesSearch && matchesStatus && matchesPlatform && matchesAccount;
    });
    
    currentPage = 1;
    renderPosts();
    updatePagination();
    
    if (filteredPosts.length === 0) {
        showEmptyState();
    } else {
        hideEmptyState();
    }
}

function clearFilters() {
    document.getElementById('searchPosts').value = '';
    document.getElementById('filterStatus').value = '';
    document.getElementById('filterPlatform').value = '';
    document.getElementById('filterAccount').value = '';
    
    filteredPosts = [...allPosts];
    currentPage = 1;
    renderPosts();
    updatePagination();
    hideEmptyState();
}

function updatePagination() {
    const totalPages = Math.ceil(filteredPosts.length / postsPerPage);
    const startIndex = (currentPage - 1) * postsPerPage + 1;
    const endIndex = Math.min(currentPage * postsPerPage, filteredPosts.length);
    
    // Update pagination info
    document.getElementById('paginationStart').textContent = filteredPosts.length > 0 ? startIndex : 0;
    document.getElementById('paginationEnd').textContent = endIndex;
    document.getElementById('paginationTotal').textContent = filteredPosts.length;
    
    // Update pagination controls
    document.getElementById('prevPage').disabled = currentPage <= 1;
    document.getElementById('nextPage').disabled = currentPage >= totalPages;
    
    // Update page numbers
    const pageNumbers = document.getElementById('pageNumbers');
    pageNumbers.innerHTML = '';
    
    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
            const pageBtn = document.createElement('button');
            pageBtn.className = `page-number ${i === currentPage ? 'active' : ''}`;
            pageBtn.textContent = i;
            pageBtn.onclick = () => goToPage(i);
            pageNumbers.appendChild(pageBtn);
        } else if (i === currentPage - 3 || i === currentPage + 3) {
            const ellipsis = document.createElement('span');
            ellipsis.textContent = '...';
            ellipsis.style.padding = '6px 12px';
            pageNumbers.appendChild(ellipsis);
        }
    }
}

function goToPage(page) {
    currentPage = page;
    renderPosts();
    updatePagination();
}

function previousPage() {
    if (currentPage > 1) {
        goToPage(currentPage - 1);
    }
}

function nextPage() {
    const totalPages = Math.ceil(filteredPosts.length / postsPerPage);
    if (currentPage < totalPages) {
        goToPage(currentPage + 1);
    }
}

function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.post-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
    
    updateSelectedPosts();
}

function updateSelectedPosts() {
    const checkboxes = document.querySelectorAll('.post-checkbox:checked');
    selectedPosts = Array.from(checkboxes).map(cb => parseInt(cb.value));
    
    // Update select all checkbox
    const selectAll = document.getElementById('selectAll');
    const allCheckboxes = document.querySelectorAll('.post-checkbox');
    selectAll.checked = allCheckboxes.length > 0 && checkboxes.length === allCheckboxes.length;
    selectAll.indeterminate = checkboxes.length > 0 && checkboxes.length < allCheckboxes.length;
    
    // Update bulk actions count
    const countElement = document.getElementById('selectedPostsCount');
    if (countElement) {
        countElement.textContent = selectedPosts.length;
    }
}

async function editPost(postId) {
    try {
        const response = await fetch(`/api/posts/${postId}`);
        const data = await response.json();
        
        if (data.success) {
            const post = data.post;
            
            // Populate edit form
            document.getElementById('editPostId').value = post.id;
            document.getElementById('editPostTitle').value = post.title || '';
            document.getElementById('editPostContent').value = post.content || '';
            document.getElementById('editPostPlatform').value = post.platform;
            document.getElementById('editPostAccount').value = post.account_id || '';
            document.getElementById('editPostStatus').value = post.status;
            
            // Load accounts for edit form
            await loadAccountsForEdit();
            
            // Show modal
            document.getElementById('editPostModal').style.display = 'flex';
        } else {
            showNotification(data.message || 'Error loading post', 'error');
        }
    } catch (error) {
        console.error('Error loading post:', error);
        showNotification('Error loading post', 'error');
    }
}

async function loadAccountsForEdit() {
    try {
        const response = await fetch('/api/accounts');
        const data = await response.json();
        
        if (data.success && data.accounts) {
            const select = document.getElementById('editPostAccount');
            select.innerHTML = '<option value="">Select account...</option>';
            
            data.accounts.forEach(account => {
                const option = document.createElement('option');
                option.value = account.id;
                option.textContent = `${account.platform} - ${account.account_name}`;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error loading accounts:', error);
    }
}

async function updatePost() {
    const formData = new FormData(document.getElementById('editPostForm'));
    const postId = formData.get('post_id');
    
    try {
        const response = await fetch(`/api/posts/${postId}`, {
            method: 'PUT',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('Post updated successfully!', 'success');
            closeEditPostModal();
            loadPosts();
        } else {
            showNotification(data.message || 'Error updating post', 'error');
        }
    } catch (error) {
        console.error('Error updating post:', error);
        showNotification('Error updating post', 'error');
    }
}

function closeEditPostModal() {
    document.getElementById('editPostModal').style.display = 'none';
}

async function duplicatePost(postId) {
    try {
        const response = await fetch(`/api/posts/${postId}/duplicate`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('Post duplicated successfully!', 'success');
            loadPosts();
        } else {
            showNotification(data.message || 'Error duplicating post', 'error');
        }
    } catch (error) {
        console.error('Error duplicating post:', error);
        showNotification('Error duplicating post', 'error');
    }
}

async function retryPost(postId) {
    try {
        const response = await fetch(`/api/posts/${postId}/retry`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('Post retry initiated!', 'success');
            loadPosts();
        } else {
            showNotification(data.message || 'Error retrying post', 'error');
        }
    } catch (error) {
        console.error('Error retrying post:', error);
        showNotification('Error retrying post', 'error');
    }
}

async function publishPost(postId) {
    if (!confirm('Are you sure you want to publish this post now?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/posts/${postId}/publish`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('Post published successfully!', 'success');
            loadPosts();
        } else {
            showNotification(data.message || 'Error publishing post', 'error');
        }
    } catch (error) {
        console.error('Error publishing post:', error);
        showNotification('Error publishing post', 'error');
    }
}

async function deletePost(postId) {
    if (!confirm('Are you sure you want to delete this post? This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/posts/${postId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('Post deleted successfully!', 'success');
            loadPosts();
        } else {
            showNotification(data.message || 'Error deleting post', 'error');
        }
    } catch (error) {
        console.error('Error deleting post:', error);
        showNotification('Error deleting post', 'error');
    }
}

function showBulkActionsModal() {
    if (selectedPosts.length === 0) {
        showNotification('Please select posts to perform bulk actions', 'warning');
        return;
    }
    
    document.getElementById('selectedPostsCount').textContent = selectedPosts.length;
    document.getElementById('bulkActionsModal').style.display = 'flex';
}

function closeBulkActionsModal() {
    document.getElementById('bulkActionsModal').style.display = 'none';
    document.getElementById('bulkAction').value = '';
    document.getElementById('bulkScheduleSection').style.display = 'none';
}

async function executeBulkAction() {
    const action = document.getElementById('bulkAction').value;
    
    if (!action) {
        showNotification('Please select an action', 'warning');
        return;
    }
    
    if (selectedPosts.length === 0) {
        showNotification('No posts selected', 'warning');
        return;
    }
    
    let requestData = {
        post_ids: selectedPosts,
        action: action
    };
    
    if (action === 'schedule') {
        const date = document.getElementById('bulkScheduleDate').value;
        const time = document.getElementById('bulkScheduleTime').value;
        
        if (!date || !time) {
            showNotification('Please select date and time for scheduling', 'warning');
            return;
        }
        
        requestData.scheduled_at = `${date} ${time}`;
    }
    
    try {
        const response = await fetch('/api/posts/bulk', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification(`Bulk action completed successfully!`, 'success');
            closeBulkActionsModal();
            loadPosts();
            selectedPosts = [];
            document.getElementById('selectAll').checked = false;
        } else {
            showNotification(data.message || 'Error executing bulk action', 'error');
        }
    } catch (error) {
        console.error('Error executing bulk action:', error);
        showNotification('Error executing bulk action', 'error');
    }
}

function refreshPosts() {
    showNotification('Refreshing posts...', 'info');
    loadPosts();
}

async function exportPosts() {
    try {
        const response = await fetch('/api/posts/export');
        const blob = await response.blob();
        
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `posts_export_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        showNotification('Posts exported successfully!', 'success');
    } catch (error) {
        console.error('Error exporting posts:', error);
        showNotification('Error exporting posts', 'error');
    }
}

function showLoading() {
    document.getElementById('postsLoading').style.display = 'block';
    document.getElementById('postsTable').style.display = 'none';
    document.getElementById('postsEmpty').style.display = 'none';
}

function hideLoading() {
    document.getElementById('postsLoading').style.display = 'none';
    document.getElementById('postsTable').style.display = 'table';
}

function showEmptyState() {
    document.getElementById('postsEmpty').style.display = 'block';
    document.getElementById('postsTable').style.display = 'none';
}

function hideEmptyState() {
    document.getElementById('postsEmpty').style.display = 'none';
    document.getElementById('postsTable').style.display = 'table';
}

// Utility function for debouncing
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Close modals when clicking outside
document.getElementById('editPostModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeEditPostModal();
    }
});

document.getElementById('bulkActionsModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeBulkActionsModal();
    }
});

// Close modals with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        if (document.getElementById('editPostModal').style.display === 'flex') {
            closeEditPostModal();
        }
        if (document.getElementById('bulkActionsModal').style.display === 'flex') {
            closeBulkActionsModal();
        }
    }
});
</script>
{% endblock %}

